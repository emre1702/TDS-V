"use strict";var o=require("timers"),n=$("#bloodscreen"),t=$("#kill_messages_box"),r=9,a=$("#orders"),i,e=$("#audio_hit"),s=[e,e.clone(!0),e.clone(!0),e.clone(!0),e.clone(!0),e.clone(!0),e.clone(!0),e.clone(!0),e.clone(!0),e.clone(!0)],c=0,l=s.length,d=$("#audio_bombTick"),u=[d,d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0),d.clone(!0)],p=0,h=u.length,f;function playSound(e){$("#audio_"+e).trigger("play").volume=.05}function playHitsound(){s[c++].trigger("play").volume=.05,c==l&&(c=0)}function g(){s[p++].trigger("play").volume=.05,p==h&&(p=0)}function startBombTickSound(e,n){g();var t,a=3e3-2950*(n/e);null!=f&&(0,o.clearTimeout)(f),f=setTimeout(function(){return startBombTickSound(e,n+a)},a)}function stopBombTickSound(){null!=f&&((0,o.clearTimeout)(f),f=null)}function showBloodscreen(){if(i){(0,o.clearTimeout)(i);var e=n.get()[0];e.style.animation="none",e.offsetHeight,e.style.animation="BloodscreenAnim 2.5s"}else n.css({display:"block",animation:"BloodscreenAnim 2.5s"});i=setTimeout(function(){n.css("display","none"),i=null},2500)}function m(e){var n='<span style="color: white;">',t=e;return-1!==e.indexOf("~")&&(t=t.replace(/~r~/g,'</span><span style="color: rgb(222, 50, 50);">').replace(/~b~/g,'</span><span style="color: rgb(92, 180, 227);">').replace(/~g~/g,'</span><span style="color: rgb(113, 202, 113);">').replace(/~y~/g,'</span><span style="color: rgb(238, 198, 80);">').replace(/~o~/g,'</span><span style="color: rgb(253, 132, 85);">').replace(/~s~/g,'</span><span style="color: rgb(220, 220, 220);">').replace(/~w~/g,'</span><span style="color: white;">').replace(/~dr~/g,'</span><span style="color: rgb( 169, 25, 25 );">').replace(/~n~/g,"<br>")),n+t+"</span>"}function v(e){e.remove()}function addKillMessage(e){var n=$("<text>"+m(e)+"<br></text>");t.append(n),n.delay(11e3).fadeOut(4e3,n.remove)}function loadOrderNames(e){a.empty();var n=JSON.parse(e),t=0;Object.keys(n).forEach(function(e){a.append($("<div>"+ ++t+". "+n[e]+"</div>"))})}var b=$("#mapmenu"),_=$("#tabs-1"),y=$("#tabs-2"),w=$("#tabs-3"),x=$(R),C=$("#map_info"),O=$("#choose_map_button"),k=$("#add_map_to_favourites"),T=$("#mapvoting"),S,B="",N=!1,D=[],A=[],J="",M=!1,q=!1,I=!1,R="#tabs-4",H=!0;function openMapMenu(e,n){b.show(1e3),N=!0,r=e,J=B="",_.empty(),y.empty(),w.empty(),x.empty(),S=JSON.parse(n);for(var t=0;t<S.length;++t){var a=$("<div>"+S[t].Name+"</div>");0===S[t].Type?_.append(a):y.append(a),-1!==A.indexOf(S[t].Name)&&w.append(a.clone())}for(var o=0;o<D.length;++o)x.append($("<div>"+D[o].name+"</div>"));_.selectable("refresh"),y.selectable("refresh"),w.selectable("refresh"),x.selectable("refresh")}function closeMapMenu(){N=!1,b.hide(500),q&&(O.hide(500),C.hide(500),k.hide(500),q=!1)}function j(e,n){return e.votes>n.votes?-1:1}function F(){D.sort(j)}function L(e){D.push({name:e,votes:1});var n=$("<div>"+D.length+". "+e+" (1)</div>");T.append(n),N&&(x.append($("<div>"+e+"</div>")),x.selectable("refresh")),J===e&&(n.addClass("mapvoting_selected"),J="")}function U(){for(var e=T.children(),n=0;n<e.length;++n)n in D?e.eq(n).text(n+1+". "+mapname+" ("+votes[n].votings+")"):D.splice(n)}function V(e){for(var n=0;n<D.length;++n)if(D[n].name===e)return--D[n].votes<=0&&(D.splice(n,1),T.children().eq(n).remove(),N&&$(R+" div:contains("+e+")")),void U()}function addVoteToMapVoting(e,n){J===e&&$(".mapvoting_selected").removeClass("mapvoting_selected"),void 0!==n&&V(n);for(var t=!1,a=0;a<D.length&&!t;++a)if(D[a].name===e){++D[a].votes;var o=T.children().eq(a);o.text(a+1+". "+e+"("+D[a].votes+")"),J===e&&(o.addClass("mapvoting_selected"),J=""),t=!0}t||L(e),F()}function loadMapVotings(e){var n=JSON.parse(mapsvotesjson);for(var t in D=[],n)D.push({name:t,votes:n[t]});F()}function clearMapVotings(){D=[],T.empty(),N&&(x.empty(),x.selectable("refresh"))}function E(){M=!0,O.disabled=!0,setTimeout(function(){M=!1,O.disabled=!1},1500)}function W(e){-1!==A.indexOf(e)?I||(k.removeClass("add_map_to_favourites_notselected").addClass("add_map_to_favourites_selected"),I=!0):I&&(k.removeClass("add_map_to_favourites_selected").addClass("add_map_to_favourites_notselected"),I=!1)}function loadFavouriteMaps(e){A=JSON.parse(e)}function toggleCanVoteForMapWithNumpad(e){(H=e)?(a.hide(300),T.show(300)):(a.show(300),T.hide(300))}$(document).ready(function(){b=$("#mapmenu"),_=$("#tabs-1"),y=$("#tabs-2"),w=$("#tabs-3"),x=$(R),C=$("#map_info"),O=$("#choose_map_button"),k=$("#add_map_to_favourites"),T=$("#mapvoting"),$("#tabs").tabs({collapsible:!0,heightStyle:"fill"}),$(".tab_list").each(function(e,n){$(this).selectable({selected:function e(n,t){$(".ui-selected").removeClass("ui-selected"),$(t.selected).addClass("ui-selected");var a=t.selected.innerHTML;W(a);for(var o=0;o<S.length;++o)if(a===S[o].Name)return B=a,q||(O.show(0),C.show(0),k.show(0),q=!0),void C.html(S[o].Description[r])},autoRefresh:!1})}),O.click(function(e){e.preventDefault(),M||""!==B&&(J=B,mp.trigger("MapVote_Browser",J),E())}),k.click(function(e){if(e.preventDefault(),""!==B){var n=A.indexOf(B);-1===n?(A.push(B),k.removeClass("add_map_to_favourites_notselected").addClass("add_map_to_favourites_selected"),mp.trigger("ToggleMapFavouriteState_Browser",B,!0),w.append($("<div>"+B+"</div>"))):(A.splice(n,1),k.removeClass("add_map_to_favourites_selected").addClass("add_map_to_favourites_notselected"),mp.trigger("ToggleMapFavouriteState_Browser",B,!1),w.children("div:contains('"+B+"')").remove()),w.selectable("refresh")}}),$("body").keydown(function(e){var n=e.which;if(H&&97<=n&&n<=105){if(M)return;e.preventDefault();var t=9-(105-n)-1;D.length>t&&(J=D[t].name,mp.trigger("MapVote_Browser",J),E())}})});var Z={amountentries:[0,0],maxentries:40,active:!0,inputshowing:!1,maininput:$("#main-input"),bodies:[$("#normal-chat-body"),$("#dirty-chat-body")],chatends:["$normal$","$dirty$"],chosentab:null,chosenchatbody:0,myname:null,globalsaykeycode:"Z"===String.fromCharCode(90)?90:Y,playernames:[],autocompleteon:!1},z=[[/#r#/g,"rgb(222, 50, 50)"],[/#b#/g,"rgb(92, 180, 227)"],[/#g#/g,"rgb(113, 202, 113)"],[/#y#/g,"rgb(238, 198, 80)"],[/#p#/g,"rgb(131, 101, 224)"],[/#q#/g,"rgb(226, 79, 128)"],[/#o#/g,"rgb(253, 132, 85)"],[/#s#/g,"rgb(220, 220, 220)"],[/#w#/g,"white"],[/#dr#/g,"rgb(169, 25, 25)"]];function G(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;(e=null===e?ne():e).finish().animate({scrollTop:e.prop("scrollHeight")},"slow")}function enableChatInput(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";!Z.active&&e||e!==Z.inputshowing&&(mp.invoke("focus",e),e?(Z.maininput.fadeIn(),Z.maininput.val(n),setTimeout(function(){Z.maininput.focus()},100)):(Z.maininput.hide(),Z.maininput.val("")),Z.inputshowing=e,mp.trigger("ChatInputToggled_Browser",e))}var chatAPI={};function K(e){for(var n=e.indexOf("!{");-1!=n;){var t=e.indexOf("}",n+2);if(-1==t)break;var a=e.substring(n,t+1),o=a.substring(2,a.length-1).split("|"),r=void 0;1==o.length?r=o[0]:o.length<3?r="rgb(".concat(0 in o?o[0]:0,", ").concat(1 in o?o[1]:0,", 0)"):3==o.length?r="rgb(".concat(o[0],", ").concat(o[1],", ").concat(o[2],")"):4==o.length&&(r="rgba(".concat(o[0],", ").concat(o[1],", ").concat(o[2],", ").concat(o[3],")"));var i="</span><span style='color: "+r+";'>";n=(e=e.replace(a,i)).indexOf("!{",n+i.length)}return e}function P(e,n){var t="";n&&(t='<span style="background-color: rgba(255,178,102,0.6);">'),t+='<span style="color: white;">';var a=e;if(-1!==e.indexOf("#")){for(var o=0;o<z.length;++o)a=a.replace(z[o][0],"</span><span style='color: "+z[o][1]+";'>");a=a.replace(/#n#/g,"<br>")}return a=K(a),n&&(a+="</span>"),t+a+"</span>"}function Q(e){if(null===Z.myname)return!1;var n=e.indexOf("@");if(-1===n)return!1;var t=e.indexOf(":",n+1),a;return-1!==t&&e.substring(n+1,t)===Z.myname}function X(e,n,t){n.append(e),++Z.amountentries[t]>=Z.maxentries&&(--Z.amountentries[t],n.find("text:first").remove()),G(n)}function ee(e){for(var n=Q(e),t=0;t<Z.chatends.length;++t)if(e.endsWith(Z.chatends[t])){e=e.slice(0,-Z.chatends[t].length);var a=ne(t),o=P(e,n),r;return void X($("<text>"+o+"</text>"),a,t)}for(var i=P(e,n),s=0;s<Z.bodies.length;++s){var c=ne(s),l;X($("<text>"+i+"</text>"),c,s)}}function ne(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:-1,n=-1===e?Z.chosenchatbody:e;return Z.bodies[n]}function loadUserName(e){Z.myname=e,Z.playernames.push(e)}function loadNamesForChat(e){Z.playernames=JSON.parse(e)}function addNameForChat(e){Z.playernames.push(e)}function removeNameForChat(e){var n=Z.playernames.indexOf(e);-1!=n&&Z.playernames.splice(n,1)}function te(e){return void 0===e||null==e||e.replace(/\s/g,"").length<1}chatAPI.push=ee,chatAPI.clear=function(){ne().html("")},chatAPI.activate=function(e){Z.active=e},chatAPI.show=function(e){e?(ne().show(),$("#chat_choice").show()):(ne().hide(),$("#chat_choice").hide()),Z.active=e},$(document).ready(function(){addAutocomplete(Z.maininput,Z.playernames,function(){return!(Z.autocompleteon=!0)},function(){setTimeout(function(){Z.autocompleteon=!1},500)}),$("body").keydown(function(e){if(13===e.which&&Z.inputshowing&&!Z.autocompleteon){e.preventDefault();var n=Z.maininput.val();te(n)?mp.trigger("CloseChat_Browser"):"/"===(n=n.replace(/\\/g,"\\\\").replace(/\"/g,'\\"'))[0]?0<(n=n.substr(1)).length&&mp.trigger("CommandUsed_Browser",n):mp.trigger("ChatUsed_Browser",n,1==Z.chosenchatbody)}}),Z.chosentab=$("#chat_choice div[data-chatID=0]"),Z.chosentab.css("background","#04074e"),$("#chat_choice div").click(function(){Z.chosenchatbody!==$(this).attr("data-chatID")&&(Z.chosentab.css("background","#A9A9A9"),Z.bodies[Z.chosenchatbody].hide(400),Z.chosentab=$(this),Z.chosentab.css("background","#04074e"),Z.chosenchatbody=Z.chosentab.attr("data-chatID"),Z.bodies[Z.chosenchatbody].show(400))}),mp.trigger("ChatLoaded_Browser")});var ae=$("#round_end_reason"),oe=$("#round_end_reason_container"),re={},ie,se=new SimpleStarRating($("#map_rating_stars")[0],function(e){ie in re&&re[ie]===e||(re[ie]=e,mp.trigger("sendMapRating",ie,e),se.disable())});function showRoundEndReason(e,n){ae.html(e),oe.css("display","table"),(ie=n)in re?se.setCurrentRating(re[n]):se.setCurrentRating(0),se.enable()}function hideRoundEndReason(){oe.hide()}function loadMyMapRatings(e){re=JSON.parse(e)}