<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>TDS voice</title>
        <script src="dist/RTCMultiConnection.min.js"></script>
        <script src="dev/getHTMLMediaElement.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            #talking_info {
                position: absolute;
                top: 48%;
                left: 1%;
                font-size: 1.0em;
                overflow: hidden;
                max-height: 52%;
                color: #fff;
                text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;
            }

            .talking_name {
                position: relative;
            }
        </style>
    </head>
    <body>
        <div id="audios_container"></div>
        <div id="talking_info"></div>
        <script>
            let talkinginfo = document.getElementById( "talking_info" );
        	let connection = new RTCMultiConnection();
            let mystream = null;
            let pressingpushtotalk = false;
            let alreadyjoined = false;

			connection.socketURL = '/';

			connection.socketMessageEvent = 'TDS-voice';
			connection.leaveOnPageUnload = false;

			connection.session = {
			    audio: true,
			    video: false
			};

			connection.mediaConstraints = {
			    audio: true,
			    video: false
			};

			connection.sdpConstraints.mandatory = {
			    OfferToReceiveAudio: true,
			    OfferToReceiveVideo: false
            };

            connection.extra = {
                username: ""
            }

			connection.audiosContainer = document.getElementById( "audios_container" );

			connection.onstream = function ( event ) {
                event.mediaElement.id = event.extra.username;

			    if ( event.type == "local" ) {
			    	mystream = event.stream;
			    	event.stream.mute ( "audio" );
			    }
			};

            connection.onmute = function ( event ) {
                removeTalking( event.mediaElement.id );
            }

            connection.onunmute = function ( event ) {
                addTalking( event.mediaElement.id );
            }

            function joinRoom( room, username ) {
                clearTalking();
                if ( connection.extra.username == "" )
                    connection.extra.username = username;
                if ( alreadyjoined )
                	connection.leave();
                connection = true;
				connection.openOrJoin ( room );
            }

            function addTalking( name ) {
                let div = document.createElement( "div" );
                div.innerHTML = name;
                div.className = "talking_name";
                div.id = name;
                talkinginfo.appendChild( div );
            }

            function removeTalking( name ) {
                let div = document.getElementById( name );
                div.outerHTML = "";
                delete div;
            }

            function clearTalking() {
                while ( talkinginfo.firstChild ) {
                    talkinginfo.removeChild( talkinginfo.firstChild );
                }
            }


            document.onkeydown = function ( event ) {
                if ( !pressingpushtotalk ) {
                    if ( mystream != null && event.keyCode == 0x58 ) { // X
                        pressingpushtotalk = true;
                        mystream.unmute( "audio" );
                    }
                }
			};

            document.onkeyup = function ( event ) {
                if ( pressingpushtotalk ) {
                    if ( mystream != null && event.keyCode == 0x58 ) {  // X
                        pressingpushtotalk = false;
                        mystream.mute( "audio" );
                    }
                }
            };

		</script>
    </body>
</html>